<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Конструктор карточки товара</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#1976d2">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* ... твой CSS без изменений ... */
    :root {
      --glass-bg: rgba(34, 34, 34, 0.65);
      --glass-blur: 18px;
      --accent: #2a7cff;
      --accent-hover: #1856b3;
      --border: rgba(255,255,255,0.12);
      --shadow: 0 8px 32px 0 rgba(0,0,0,0.25);
      --radius: 22px;
      --panel-width: 340px;
      --canvas-max: 800px;
      --font-main: 'Inter', 'Segoe UI', Arial, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
      --transition: 0.18s cubic-bezier(.4,0,.2,1);
    }
    @media (prefers-color-scheme: light) {
      :root {
        --glass-bg: rgba(255,255,255,0.75);
        --border: rgba(0,0,0,0.08);
        --shadow: 0 8px 32px 0 rgba(0,0,0,0.10);
        --accent: #2a7cff;
        --accent-hover: #1856b3;
      }
      body { color: #222; }
    }
    body {
  body {
  margin: 0;
  font-family: 'Montserrat', Arial, sans-serif;
  background: #f6f7fa;
}
.main-layout {
  display: flex;
  height: 100vh;
}
.side-panel {
  width: 340px;
  background: #fff;
  border-right: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
  padding: 0;
  box-shadow: 2px 0 8px #0001;
  z-index: 2;
}
.tabs {
  display: flex;
  border-bottom: 1px solid #e0e0e0;
  background: #f6f7fa;
}
.tab-btn {
  flex: 1;
  padding: 12px 0;
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  transition: background 0.2s;
  border-bottom: 2px solid transparent;
}
.tab-btn.active {
  background: #fff;
  border-bottom: 2px solid #1976d2;
  color: #1976d2;
}
.tab-content {
  display: none;
  padding: 18px 18px 0 18px;
  flex: 1;
  overflow-y: auto;
}
.tab-content.active {
  display: block;
}
.upload-btn {
  display: block;
  background: #1976d2;
  color: #fff;
  border-radius: 8px;
  padding: 12px;
  text-align: center;
  font-weight: bold;
  margin-bottom: 18px;
  cursor: pointer;
  transition: background 0.2s;
}
.upload-btn:hover {
  background: #1256a2;
}
#thumbnails {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 18px;
}
.batch-item {
  position: relative;
  display: flex;
  align-items: center;
  background: #f6f7fa;
  border-radius: 8px;
  padding: 4px 8px;
  transition: border 0.2s;
}
.batch-item .color-circle {
  margin-left: 8px;
  border: 2px solid #fff;
  box-shadow: 0 0 0 1.5px #1976d2;
}
.color-select-row, .form-row {
  display: flex;
  align-items: center;
  margin-bottom: 14px;
  gap: 8px;
}
.color-select-row label, .form-row label {
  min-width: 70px;
  font-weight: 500;
}
.color-select-row select, .form-row select, .form-row input[type="text"] {
  flex: 1;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 15px;
}
.color-select-row button, .form-row button {
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 6px;
  width: 28px;
  height: 28px;
  font-size: 20px;
  cursor: pointer;
  transition: background 0.2s;
}
.color-select-row button:hover, .form-row button:hover {
  background: #1256a2;
}
.main-action-btn {
  margin: 18px;
  padding: 14px 0;
  background: #43a047;
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.2s;
}
.main-action-btn:hover {
  background: #2e7031;
}
.canvas-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: #f6f7fa;
  position: relative;
}
#product-canvas {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 32px #0002;
  margin: 32px 0 0 0;
  display: block;
  width: 900px;
  height: 600px;
  max-width: 100%;
  max-height: 80vh;
}
.canvas-controls {
  display: flex;
  gap: 24px;
  margin: 18px 0 0 0;
  align-items: center;
  justify-content: center;
}
.canvas-controls label {
  font-size: 15px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}
input[type="range"] {
  accent-color: #1976d2;
  width: 90px;
}
input[type="color"] {
  border: none;
  background: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 0 0 1.5px #1976d2;
}
::-webkit-scrollbar {
  width: 8px;
  background: #f6f7fa;
}
::-webkit-scrollbar-thumb {
  background: #e0e0e0;
  border-radius: 4px;
}
    .main-flex {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      gap: 32px;
      padding: 40px 0;
    }
    .glass-panel {
      background: var(--glass-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1.5px solid var(--border);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      padding: 32px 28px 28px 28px;
      min-width: 260px;
      max-width: var(--panel-width);
      display: flex;
      flex-direction: column;
      gap: 18px;
      transition: background var(--transition), box-shadow var(--transition);
      position: relative;
      z-index: 2;
    }
    .glass-panel h2 {
      margin: 0 0 10px 0;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.01em;
      color: var(--accent);
      text-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .glass-panel label {
      display: flex;
      flex-direction: column;
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 0;
      gap: 4px;
      color: inherit;
    }
    .glass-panel input[type=text], .glass-panel select, .glass-panel input[type=color] {
      margin-bottom: 0;
      padding: 7px 12px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      font-size: 1rem;
      font-family: inherit;
      background: rgba(255,255,255,0.08);
      color: inherit;
      outline: none;
      transition: border-color var(--transition), background var(--transition);
    }
    .glass-panel input[type=text]:focus, .glass-panel select:focus {
      border-color: var(--accent);
      background: rgba(255,255,255,0.16);
    }
    .glass-panel input[type=color] {
      width: 38px; height: 38px; padding: 0; border: none; background: none;
    }
    .glass-panel input[type=file] { margin-bottom: 0; }
    .glass-panel .row { display: flex; gap: 10px; width: 100%; }
    .glass-panel .row > * { flex: 1; }
    .bottom-part-block {
      background: rgba(255,255,255,0.07);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
    }
    .bottom-part-block label { font-size: 0.97rem; }
    .font-row, .font-upload-row {
      display: flex; align-items: center; gap: 10px; width: 100%;
    }
    .font-row label, .font-upload-row label { flex: 1; margin-bottom: 0; }
    .font-row input[type=range] { width: 100px; }
    .save-btn {
      margin-top: 10px;
      padding: 12px 0;
      font-size: 1.1rem;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 12px 0 rgba(42,124,255,0.10);
      transition: background var(--transition), box-shadow var(--transition), transform var(--transition);
      letter-spacing: 0.03em;
    }
    .save-btn:hover { background: var(--accent-hover); transform: translateY(-2px) scale(1.03);}
    #canvas-wrap {
      max-width: var(--canvas-max);
      min-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      z-index: 1;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: rgba(17,17,17,0.92);
      border-radius: 24px;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18);
      border: 2px solid var(--border);
      transition: box-shadow var(--transition);
      max-width: 100%;
      height: auto;
    }
    .icon {
      width: 1.1em; height: 1.1em; vertical-align: -0.15em; margin-right: 0.3em; opacity: 0.7;
    }
    .batch-list {
      margin: 10px 0 0 0;
      padding: 0;
      list-style: none;
    }
    .batch-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .batch-item img {
      width: 48px; height: 48px; object-fit: cover; border-radius: 8px; border: 1.5px solid #444;
    }
    .batch-item select {
      min-width: 100px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1.5px solid #444;
      background: #fff;
      color: #111;
      font-weight: 600;
      padding: 3px 8px;
    }
    .batch-item .color-circle {
      display: inline-block;
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 1.5px solid #444;
      margin-left: 8px;
      vertical-align: middle;
    }
    @media (max-width: 1200px) {
      .main-flex { flex-direction: column; align-items: center; gap: 18px; }
      .glass-panel { max-width: 98vw; min-width: 0; width: 98vw; }
      #canvas-wrap { width: 98vw; }
    }
    @media (max-width: 700px) {
      .main-flex { padding: 10px 0; }
      .glass-panel { padding: 18px 8px 14px 8px; }
      #canvas-wrap { min-width: 0; }
    }



    .modal {
  position: fixed;
  z-index: 10000;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(34,34,34,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  animation: modal-fade-in 0.2s;
}
@keyframes modal-fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-content {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 32px 0 rgba(0,0,0,0.18);
  padding: 32px 28px 24px 28px;
  min-width: 320px;
  max-width: 90vw;
  display: flex;
  flex-direction: column;
  gap: 18px;
  position: relative;
}
.modal-content h3 {
  margin: 0 0 10px 0;
  font-size: 1.2rem;
  font-weight: 700;
  color: #1976d2;
}
.modal-content label {
  display: flex;
  flex-direction: column;
  font-size: 1rem;
  font-weight: 500;
  gap: 4px;
  color: #222;
}
.modal-content input[type="text"] {
  padding: 7px 12px;
  border-radius: 8px;
  border: 1.5px solid #ccc;
  font-size: 1rem;
  font-family: inherit;
  background: #f6f7fa;
  color: #222;
  outline: none;
  transition: border-color 0.18s;
}
.modal-content input[type="text"]:focus {
  border-color: #1976d2;
}
.modal-content input[type="color"] {
  width: 38px; height: 38px; padding: 0; border: none; background: none;
}
.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 8px;
}
.modal-save {
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.18s;
}
.modal-save:hover { background: #1256a2; }
.modal-cancel {
  background: #eee;
  color: #222;
  border: none;
  border-radius: 8px;
  padding: 8px 18px;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.18s;
}
.modal-cancel:hover { background: #ccc; }
  </style>
<body>
  <div class="main-layout">
    <aside class="side-panel">
      <div class="tabs">
        <button class="tab-btn active" data-tab="photo"><span>📷</span> Фото</button>
        <button class="tab-btn" data-tab="text"><span>📝</span> Текст</button>
        <button class="tab-btn" data-tab="style"><span>🎨</span> Оформление</button>
      </div>
      <div class="tab-content active" id="tab-photo">
        <label class="upload-btn">
          <input type="file" id="product-photo-upload" multiple accept="image/*" hidden>
          <span>+ Загрузить фото</span>
        </label>
        <div id="thumbnails"></div>
        <div class="color-select-row">
          <label>Цвет:</label>
          <select id="color-input"></select>
          <button id="add-color-btn" title="Добавить цвет">+</button>
        </div>
      </div>
      <div class="tab-content" id="tab-text">
        <div class="form-row">
          <label>Бренд:</label>
          <select id="brand-input"></select>
          <button id="add-brand-btn" title="Добавить бренд">+</button>
        </div>
        <div class="form-row">
          <label>Категория:</label>
          <select id="category-input"></select>
          <button id="add-category-btn" title="Добавить категорию">+</button>
        </div>
        <div class="form-row">
          <label>Ткань:</label>
          <select id="fabric-input"></select>
          <button id="add-fabric-btn" title="Добавить ткань">+</button>
        </div>
        <div class="form-row">
          <label>Размер:</label>
          <select id="size-type-input">
            <option value="норма">Норма</option>
            <option value="батал">Батал</option>
            <option value="oversize">Oversize</option>
          </select>
        </div>
        <div class="form-row">
          <label>Артикул:</label>
          <input id="sku-input" type="text" maxlength="32">
        </div>
        <div class="form-row">
          <label><input type="checkbox" id="fabric-toggle" checked> Показывать ткань</label>
        </div>
      </div>
      <div class="tab-content" id="tab-style">
        <div class="form-row">
          <label>Шрифт:</label>
          <select id="font-family-input">
            <option value="Arial">Arial</option>
            <option value="Montserrat">Montserrat</option>
            <option value="Roboto">Roboto</option>
          </select>
        </div>
        <div class="form-row">
          <label>Размер шрифта:</label>
          <input id="font-size-input" type="range" min="16" max="48" value="24">
          <span id="font-size-value">24</span>
        </div>
        <div class="form-row">
          <label>Цвет текста:</label>
          <input id="color-text-input" type="color" value="#222222">
        </div>
        <div class="form-row">
          <label>Обводка:</label>
          <input id="stroke-width-input" type="range" min="0" max="8" value="0">
          <span id="stroke-width-value">0</span>
          <input id="stroke-color-input" type="color" value="#ffffff">
        </div>
        <div class="form-row">
          <label>Межстрочный:</label>
          <input id="line-height-input" type="range" min="0" max="32" value="8">
          <span id="line-height-value">8</span>
        </div>
        <div class="form-row">
          <label>Размер круга:</label>
          <input id="circle-size-input" type="range" min="10" max="40" value="22">
          <span id="circle-size-value">22</span>
        </div>
        <div class="form-row">
          <label>Смещение круга:</label>
          <input id="color-circle-offset-input" type="range" min="-50" max="50" value="0">
          <span id="color-circle-offset-value">0</span>
        </div>
        <div class="form-row">
          <label>Смещение X круга:</label>
          <input id="color-circle-xoffset-input" type="range" min="-50" max="50" value="0">
          <span id="color-circle-xoffset-value">0</span>
        </div>
        <div class="form-row">
          <label>Затемнение фона:</label>
          <input id="bg-darken-input" type="range" min="0" max="100" value="0">
          <span id="bg-darken-value">0</span>
        </div>
        <div class="form-row">
          <label>Фон:</label>
          <input type="file" id="bg-card-upload" accept="image/*">
        </div>
        <div class="form-row">
          <label>Выравнивание:</label>
          <select id="text-align-input">
            <option value="left">Слева</option>
            <option value="center">По центру</option>
            <option value="right">Справа</option>
          </select>
        </div>
      </div>
      <button id="save-btn" class="main-action-btn">💾 Скачать все</button>
<div class="export-import-row">
  <button id="export-btn" class="main-action-btn export-btn" style="background:#1976d2;">⬇️ Экспорт</button>
  <button id="import-btn" class="main-action-btn import-btn" style="background:#ff9800;">⬆️ Импорт</button>
  <input type="file" id="import-file" accept=".json" style="display:none;">
</div>
    </aside>
    <main class="canvas-area">
      <canvas id="product-canvas" width="900" height="600"></canvas>
      <div class="canvas-controls">
        <label>Масштаб: <input id="product-scale-input" type="range" min="10" max="200" value="92"><span id="product-scale-value">92</span></label>
        <label>X: <input id="product-x-input" type="number" min="-500" max="500" value="0"><span id="product-x-value">0</span></label>
        <label>Y: <input id="product-y-input" type="number" min="-500" max="500" value="0"><span id="product-y-value">0</span></label>
      </div>
    </main>
  </div>

     <!-- Модальное окно: Добавить цвет -->
<div class="modal" id="add-color-form" style="display:none;">
  <div class="modal-content">
    <h3>Добавить новый цвет</h3>
    <label>Название цвета:
      <input type="text" id="new-color-name" maxlength="32">
    </label>
    <label>HEX:
      <input type="color" id="new-color-hex" value="#ffffff">
      <input type="text" id="new-color-hex-text" maxlength="7" value="#ffffff" style="width:80px;">
    </label>
    <div class="modal-actions">
      <button id="save-color-btn" class="modal-save">Сохранить</button>
      <button id="cancel-color-btn" class="modal-cancel">Отмена</button>
    </div>
  </div>
</div>

<!-- Модальное окно: Добавить бренд -->
<div class="modal" id="add-brand-form" style="display:none;">
  <div class="modal-content">
    <h3>Добавить новый бренд</h3>
    <label>Название бренда:
      <input type="text" id="new-brand-name" maxlength="32">
    </label>
    <div class="modal-actions">
      <button id="save-brand-btn" class="modal-save">Сохранить</button>
      <button id="cancel-brand-btn" class="modal-cancel">Отмена</button>
    </div>
  </div>
</div>

<!-- Модальное окно: Добавить категорию -->
<div class="modal" id="add-category-form" style="display:none;">
  <div class="modal-content">
    <h3>Добавить новую категорию</h3>
    <label>Название категории:
      <input type="text" id="new-category-name" maxlength="32">
    </label>
    <div class="modal-actions">
      <button id="save-category-btn" class="modal-save">Сохранить</button>
      <button id="cancel-category-btn" class="modal-cancel">Отмена</button>
    </div>
  </div>
</div>

<!-- Модальное окно: Добавить ткань -->
<div class="modal" id="add-fabric-form" style="display:none;">
  <div class="modal-content">
    <h3>Добавить новую ткань</h3>
    <label>Название ткани:
      <input type="text" id="new-fabric-name" maxlength="32">
    </label>
    <div class="modal-actions">
      <button id="save-fabric-btn" class="modal-save">Сохранить</button>
      <button id="cancel-fabric-btn" class="modal-cancel">Отмена</button>
    </div>
  </div>
</div>
  <script>
    // --- Скрипт для работы вкладок (табы) ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
      });
    });
  </script>

<script>




  const defaultColors = {
  "White": "#fff",
  "Brown-grey": "#8d7662",
  "Orange": "#ff9800",
  "Black 05": "#222",
  "Grey": "#bdbdbd",
  "Blue 5": "#2a6cff",
  "Blue 18": "#1e3a8a",
  "Lite-blue": "#b3d8f7",
  "Green": "#2ecc40",
  "Lite-green": "#b6e7b0",
  "Antracit 2": "#444",
  "Melange": "#cfcfcf",
  "Aquamarine": "#7fffd4",
  "Beige": "#f5f5dc",
  "Red": "#e53935",
  "Graphite": "#555",
  "Yellow": "#ffe600",
  "Mentol": "#b2f9e2",
  "Mustard": "#ffd34e",
  "Khaki": "#7a8450",
  "Grenadine": "#DC343B",
  "Ultra Marine": "#3F6BAA",
  "Blue 23": "#1C4E80",
  "Green Apple": "#8DB600",
  "Coffee": "#6F4E37",
  "Terracot": "#E2725B",
  "Powder": "#F3E5AB",
  "Light Green": "#B2D732",
  "Dark Blue": "#222E50",
  "Jeans": "#3A5F81"
};
const defaultBrands = {
  "Nike": "", "Adidas": "", "Puma": "", "Reebok": "", "Boss": "", "Armani": "",
  "The North Face": "", "Karl Lagerfeld": "", "Under Armour": "", "Calvin-Klein": "", "Prada": ""
};
const defaultCategories = {
  "Футболка": "", "Борцівка": "", "Худи": "", "Свитшот": "", "Кофта с капюшоном": "",
  "Кофта без капюшона": "", "Шорты": "", "Штаны манжет": "", "Штаны прямые": "", "Костюмы": ""
};
const defaultFabrics = {
  "2 нитки": "", "3 нитки": "", "Рібана": "", "Петля": "", "Лакоста": ""
};
const sizeMap = {
  'норма': 'M, L, XL, 2XL',
  'батал': '2XL, 3XL, 3XL, 4XL',
  'oversize': 'S, M, L, XL, 2XL'
};
const templates = {
  'Футболка': {'норма': 'Футболка норма','батал': 'Футболка батал','oversize': 'Футболка Oversize'}
};

function getCustomList(key, defaults) {
  return JSON.parse(localStorage.getItem(key) || 'null') || defaults;
}
function setCustomList(key, list) {
  localStorage.setItem(key, JSON.stringify(list));
}
function updateSelect(selectId, list) {
  const select = document.getElementById(selectId);
  select.innerHTML = '';
  for (const [name, value] of Object.entries(list)) {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    if (selectId === 'color-input') {
      opt.style.background = value;
      opt.style.color = '#222';
    }
    select.appendChild(opt);
  }
}
function getColorHex(name) {
  const colors = getCustomList('customColors', defaultColors);
  return colors[name] || '#fff';
}
function updateColorSelect() {
  updateSelect('color-input', getCustomList('customColors', defaultColors));
}
function updateBrandSelect() { updateSelect('brand-input', getCustomList('customBrands', defaultBrands)); }
function updateCategorySelect() { updateSelect('category-input', getCustomList('customCategories', defaultCategories)); }
function updateFabricSelect() { updateSelect('fabric-input', getCustomList('customFabrics', defaultFabrics)); }
updateColorSelect(); updateBrandSelect(); updateCategorySelect(); updateFabricSelect();

/* --- Добавление новых значений через интерфейс --- */
document.getElementById('add-color-btn').onclick = function() {
  document.getElementById('add-color-form').style.display = '';
};
document.getElementById('cancel-color-btn').onclick = function() {
  document.getElementById('add-color-form').style.display = 'none';
};
document.getElementById('new-color-hex').oninput = function() {
  document.getElementById('new-color-hex-text').value = this.value;
};
document.getElementById('new-color-hex-text').oninput = function() {
  document.getElementById('new-color-hex').value = this.value;
};
document.getElementById('save-color-btn').onclick = function() {
  const name = document.getElementById('new-color-name').value.trim();
  const hex = document.getElementById('new-color-hex').value;
  if (!name) return alert('Введите название цвета!');
  const colors = getCustomList('customColors', defaultColors);
  colors[name] = hex;
  setCustomList('customColors', colors);
  updateColorSelect();
  document.getElementById('color-input').value = name;
  document.getElementById('add-color-form').style.display = 'none';
  document.getElementById('new-color-name').value = '';
  updateAllThumbnailColorSelects();
  if (!productPhotoImages.length) drawProductCard();
};
document.getElementById('add-brand-btn').onclick = function() {
  document.getElementById('add-brand-form').style.display = '';
};
document.getElementById('cancel-brand-btn').onclick = function() {
  document.getElementById('add-brand-form').style.display = 'none';
};
document.getElementById('save-brand-btn').onclick = function() {
  const name = document.getElementById('new-brand-name').value.trim();
  if (!name) return alert('Введите название бренда!');
  const brands = getCustomList('customBrands', defaultBrands);
  brands[name] = "";
  setCustomList('customBrands', brands);
  updateBrandSelect();
  document.getElementById('brand-input').value = name;
  document.getElementById('add-brand-form').style.display = 'none';
  document.getElementById('new-brand-name').value = '';
};
document.getElementById('add-category-btn').onclick = function() {
  document.getElementById('add-category-form').style.display = '';
};
document.getElementById('cancel-category-btn').onclick = function() {
  document.getElementById('add-category-form').style.display = 'none';
};
document.getElementById('save-category-btn').onclick = function() {
  const name = document.getElementById('new-category-name').value.trim();
  if (!name) return alert('Введите название товара!');
  const categories = getCustomList('customCategories', defaultCategories);
  categories[name] = "";
  setCustomList('customCategories', categories);
  updateCategorySelect();
  document.getElementById('category-input').value = name;
  document.getElementById('add-category-form').style.display = 'none';
  document.getElementById('new-category-name').value = '';
};
document.getElementById('add-fabric-btn').onclick = function() {
  document.getElementById('add-fabric-form').style.display = '';
};
document.getElementById('cancel-fabric-btn').onclick = function() {
  document.getElementById('add-fabric-form').style.display = 'none';
};
document.getElementById('save-fabric-btn').onclick = function() {
  const name = document.getElementById('new-fabric-name').value.trim();
  if (!name) return alert('Введите название ткани!');
  const fabrics = getCustomList('customFabrics', defaultFabrics);
  fabrics[name] = "";
  setCustomList('customFabrics', fabrics);
  updateFabricSelect();
  document.getElementById('fabric-input').value = name;
  document.getElementById('add-fabric-form').style.display = 'none';
  document.getElementById('new-fabric-name').value = '';
};

/* --- Глобальные переменные --- */
let productPhotoImages = [];
let batchColors = [];
let currentPhotoIdx = 0;
let bgImage = null;
let sharedScale = 92;
let sharedPosition = {x: 0, y: 0};

/* --- CANVAS и элементы управления --- */
const canvas = document.getElementById('product-canvas');
const scaleValue = document.getElementById('product-scale-value');
const xValue = document.getElementById('product-x-value');
const yValue = document.getElementById('product-y-value');
const fontSizeValue = document.getElementById('font-size-value');
const lineHeightValue = document.getElementById('line-height-value');
const circleSizeValue = document.getElementById('circle-size-value');
const colorCircleOffsetValue = document.getElementById('color-circle-offset-value');
const colorCircleXOffsetValue = document.getElementById('color-circle-xoffset-value');
const bgDarkenValue = document.getElementById('bg-darken-value');
const strokeWidthValue = document.getElementById('stroke-width-value');

let isDragging = false, dragOffsetX = 0, dragOffsetY = 0;

/* --- Retina/HiDPI canvas fix --- */
function fixCanvasResolution(canvas) {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  if (canvas.width !== rect.width * dpr || canvas.height !== rect.height * dpr) {
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.imageSmoothingEnabled = true;
}

/* --- LOCALSTORAGE --- */
function saveState() {
  const state = {
    batchColors,
    currentPhotoIdx,
    productPhotoImages: productPhotoImages.map(img => img.src),
    bgImage: bgImage ? bgImage.src : null,
    sharedScale,
    sharedPosition,
    shared: {
      brand: document.getElementById('brand-input').value,
      category: document.getElementById('category-input').value,
      sizeType: document.getElementById('size-type-input').value,
      sku: document.getElementById('sku-input').value,
      fontSize: document.getElementById('font-size-input').value,
      fontFamily: document.getElementById('font-family-input').value,
      textColor: document.getElementById('color-text-input').value,
      strokeWidth: document.getElementById('stroke-width-input').value,
      strokeColor: document.getElementById('stroke-color-input').value,
      textAlign: document.getElementById('text-align-input').value,
      lineHeight: document.getElementById('line-height-input').value,
      circleSize: document.getElementById('circle-size-input').value,
      circleOffset: document.getElementById('color-circle-offset-input').value,
      circleXOffset: document.getElementById('color-circle-xoffset-input').value,
      bgDarken: document.getElementById('bg-darken-input').value,
      fabric: document.getElementById('fabric-input').value,
      fabricToggle: document.getElementById('fabric-toggle').checked
    }
  };
  localStorage.setItem('batchState', JSON.stringify(state));
}
function loadState() {
  const state = JSON.parse(localStorage.getItem('batchState') || '{}');
  if (state.productPhotoImages && state.productPhotoImages.length) {
    let loaded = 0;
    productPhotoImages = [];
    state.productPhotoImages.forEach((src, idx) => {
      const img = new window.Image();
      img.onload = () => {
        productPhotoImages[idx] = img;
        loaded++;
        if (loaded === state.productPhotoImages.length) {
          batchColors = state.batchColors || productPhotoImages.map(()=>null);
          currentPhotoIdx = state.currentPhotoIdx || 0;
          sharedScale = state.sharedScale || 92;
          sharedPosition = state.sharedPosition || {x:0, y:0};
          if (state.bgImage) {
            bgImage = new window.Image();
            bgImage.onload = () => { drawProductCard(); };
            bgImage.src = state.bgImage;
          }
          if (state.shared) {
            document.getElementById('brand-input').value = state.shared.brand;
            document.getElementById('category-input').value = state.shared.category;
            document.getElementById('size-type-input').value = state.shared.sizeType;
            document.getElementById('sku-input').value = state.shared.sku;
            document.getElementById('font-size-input').value = state.shared.fontSize;
            document.getElementById('font-family-input').value = state.shared.fontFamily;
            document.getElementById('color-text-input').value = state.shared.textColor;
            document.getElementById('stroke-width-input').value = state.shared.strokeWidth;
            document.getElementById('stroke-color-input').value = state.shared.strokeColor;
            document.getElementById('text-align-input').value = state.shared.textAlign;
            document.getElementById('line-height-input').value = state.shared.lineHeight;
            document.getElementById('circle-size-input').value = state.shared.circleSize;
            document.getElementById('color-circle-offset-input').value = state.shared.circleOffset;
            document.getElementById('color-circle-xoffset-input').value = state.shared.circleXOffset;
            document.getElementById('bg-darken-input').value = state.shared.bgDarken;
            document.getElementById('fabric-input').value = state.shared.fabric;
            document.getElementById('fabric-toggle').checked = state.shared.fabricToggle;
          }
          updateThumbnails();
          updateXYInputs();
          updateScaleInput();
          drawProductCard();
        }
      };
      img.src = src;
    });
  }
}
window.addEventListener('DOMContentLoaded', function() {
  const fabricToggle = document.getElementById('fabric-toggle');
  const fabricInput = document.getElementById('fabric-input');
  fabricInput.style.display = fabricToggle.checked ? '' : 'none';
  fabricToggle.addEventListener('change', function() {
    fabricInput.style.display = this.checked ? '' : 'none';
    drawProductCard();
    saveState();
  });

  loadState();
  drawProductCard();
  updateThumbnails();
  updateXYInputs();
  updateScaleInput();
});

/* --- ФОН --- */
document.getElementById('bg-card-upload').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    bgImage = new window.Image();
    bgImage.onload = function() {
      drawProductCard();
      saveState();
    };
    bgImage.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

/* --- MINIATYURY --- */
function updateAllThumbnailColorSelects() {
  document.querySelectorAll('.thumbnail-color-select').forEach(select => {
    const current = select.value;
    const colors = getCustomList('customColors', defaultColors);
    select.innerHTML = '';
    for (const [name, hex] of Object.entries(colors)) {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      opt.style.background = hex;
      select.appendChild(opt);
    }
    if (colors[current]) select.value = current;
  });
}
function updateThumbnails() {
  const thumbs = document.getElementById('thumbnails');
  thumbs.innerHTML = '';
  const colors = getCustomList('customColors', defaultColors);
  productPhotoImages.forEach((img, idx) => {
    const div = document.createElement('div');
    div.className = 'batch-item';
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.marginBottom = '8px';
    div.style.border = idx === currentPhotoIdx ? '2px solid #1976d2' : '2px solid #ccc';
    div.style.padding = '2px';
    div.style.cursor = 'pointer';
    div.onclick = () => { 
      currentPhotoIdx = idx; 
      updateThumbnails(); 
      drawProductCard(); 
      updateXYInputs(); 
      updateScaleInput();
      saveState(); 
    };

    // Миниатюра
    const thumbImg = document.createElement('img');
    thumbImg.src = img.src;
    thumbImg.width = 48;
    thumbImg.height = 48;
    thumbImg.style.objectFit = 'cover';
    thumbImg.style.borderRadius = '8px';
    thumbImg.style.border = '1.5px solid #444';
    div.appendChild(thumbImg);

    // Кружок цвета
    const colorCircle = document.createElement('span');
    colorCircle.className = 'color-circle';
    colorCircle.style.background = getColorHex(batchColors[idx]);
    colorCircle.style.marginLeft = '8px';
    colorCircle.style.width = '22px';
    colorCircle.style.height = '22px';
    colorCircle.style.display = 'inline-block';
    colorCircle.style.borderRadius = '50%';
    colorCircle.style.border = '1.5px solid #444';
    colorCircle.style.cursor = 'pointer';
    colorCircle.title = 'Изменить цвет';

    // Select для выбора цвета (по клику на кружок)
    const colorSelect = document.createElement('select');
    colorSelect.size = 8;
    colorSelect.style.position = 'absolute';
    colorSelect.style.display = 'none';
    colorSelect.style.zIndex = 1000;
    colorSelect.style.background = '#fff';
    colorSelect.style.border = '1px solid #888';
    colorSelect.style.fontSize = '14px';
    colorSelect.className = 'color-select-popup thumbnail-color-select';
    for (const [colorName, hex] of Object.entries(colors)) {
      const opt = document.createElement('option');
      opt.value = colorName;
      opt.textContent = colorName;
      opt.style.background = hex;
      if (batchColors[idx] === colorName) opt.selected = true;
      colorSelect.appendChild(opt);
    }
    colorSelect.onchange = (e) => { 
      batchColors[idx] = e.target.value; 
      colorCircle.style.background = getColorHex(e.target.value);
      if (idx === currentPhotoIdx) drawProductCard(); 
      saveState(); 
    };

    colorCircle.onclick = function(ev) {
      ev.stopPropagation();
      document.querySelectorAll('.color-select-popup').forEach(sel => sel.style.display = 'none');
      colorSelect.style.display = 'inline-block';
      colorSelect.focus();
    };
    colorSelect.addEventListener('mousedown', function(ev) {
      ev.stopPropagation();
    });
    document.addEventListener('mousedown', function hideSelect(e) {
      if (!div.contains(e.target)) colorSelect.style.display = 'none';
    });
    div.appendChild(colorCircle);
    div.appendChild(colorSelect);

    thumbs.appendChild(div);
  });
}

/* --- INPUTS --- */
function updateXYInputs() {
  document.getElementById('product-x-input').value = Math.round(sharedPosition.x || 0);
  document.getElementById('product-y-input').value = Math.round(sharedPosition.y || 0);
  xValue.textContent = Math.round(sharedPosition.x || 0);
  yValue.textContent = Math.round(sharedPosition.y || 0);
}
function updateScaleInput() {
  document.getElementById('product-scale-input').value = sharedScale || 92;
  scaleValue.textContent = sharedScale || 92;
}

/* --- Загрузка фото --- */
document.getElementById('product-photo-upload').addEventListener('change', function(e) {
  productPhotoImages = [];
  batchColors = [];
  currentPhotoIdx = 0;
  const files = Array.from(e.target.files);
  if (!files.length) { drawProductCard(); updateThumbnails(); saveState(); return; }
  let loaded = 0;
  const defaultColor = document.getElementById('color-input').value;
  files.forEach((file, idx) => {
    const reader = new FileReader();
    reader.onload = function(ev) {
      let img = new window.Image();
      img.onload = function() {
        productPhotoImages[idx] = img;
        batchColors[idx] = defaultColor;
        loaded++;
        if (loaded === files.length) {
          currentPhotoIdx = 0;
          drawProductCard();
          updateThumbnails();
          updateXYInputs();
          updateScaleInput();
          saveState();
        }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
});

/* --- Drag & Scale --- */
canvas.addEventListener('mousedown', function(e) {
  if (!productPhotoImages[currentPhotoIdx]) return;
  const w = canvas.width, h = canvas.height;
  const productAreaW = Math.floor(w * 0.55);
  let scale = Math.min(productAreaW / productPhotoImages[currentPhotoIdx].width, h / productPhotoImages[currentPhotoIdx].height) * (sharedScale / 100);
  let imgW = productPhotoImages[currentPhotoIdx].width * scale;
  let imgH = productPhotoImages[currentPhotoIdx].height * scale;
  let imgX = (productAreaW - imgW) / 2 + sharedPosition.x;
  let imgY = (h - imgH) / 2 + sharedPosition.y;
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  if (mouseX >= imgX && mouseX <= imgX + imgW && mouseY >= imgY && mouseY <= imgY + imgH) {
    isDragging = true;
    dragOffsetX = mouseX - imgX;
    dragOffsetY = mouseY - imgY;
    canvas.style.cursor = "grabbing";
  }
});
window.addEventListener('mousemove', function(e) {
  if (!isDragging) return;
  const w = canvas.width, h = canvas.height;
  const productAreaW = Math.floor(w * 0.55);
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;
  let scale = Math.min(productAreaW / productPhotoImages[currentPhotoIdx].width, h / productPhotoImages[currentPhotoIdx].height) * (sharedScale / 100);
  let imgW = productPhotoImages[currentPhotoIdx].width * scale;
  let imgH = productPhotoImages[currentPhotoIdx].height * scale;
  sharedPosition.x = mouseX - dragOffsetX - (productAreaW - imgW) / 2;
  sharedPosition.y = mouseY - dragOffsetY - (h - imgH) / 2;
  updateXYInputs();
  drawProductCard();
  saveState();
});
window.addEventListener('mouseup', function() {
  isDragging = false;
  canvas.style.cursor = "default";
});

canvas.addEventListener('wheel', function(e) {
  if (!productPhotoImages[currentPhotoIdx]) return;
  e.preventDefault();
  let scale = sharedScale || 92;
  if (e.deltaY < 0) scale = Math.min(scale + 2, 200);
  else scale = Math.max(scale - 2, 10);
  sharedScale = scale;
  document.getElementById('product-scale-input').value = scale;
  scaleValue.textContent = scale;
  drawProductCard();
  saveState();
}, {passive: false});

document.getElementById('product-x-input').addEventListener('input', function() {
  sharedPosition.x = parseInt(this.value, 10) || 0;
  xValue.textContent = sharedPosition.x;
  drawProductCard();
  saveState();
});
document.getElementById('product-y-input').addEventListener('input', function() {
  sharedPosition.y = parseInt(this.value, 10) || 0;
  yValue.textContent = sharedPosition.y;
  drawProductCard();
  saveState();
});
document.getElementById('product-scale-input').addEventListener('input', function() {
  sharedScale = parseInt(this.value, 10);
  scaleValue.textContent = sharedScale;
  drawProductCard();
  saveState();
});

/* --- Правая панель: все range и select --- */
[
  ['font-size-input', fontSizeValue],
  ['line-height-input', lineHeightValue],
  ['circle-size-input', circleSizeValue],
  ['color-circle-offset-input', colorCircleOffsetValue],
  ['color-circle-xoffset-input', colorCircleXOffsetValue],
  ['bg-darken-input', bgDarkenValue],
  ['stroke-width-input', strokeWidthValue]
].forEach(([id, span]) => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('input', function() {
      span.textContent = this.value;
      drawProductCard();
      saveState();
    });
  }
});

[
  'brand-input','category-input','size-type-input','sku-input','font-family-input',
  'color-text-input','stroke-width-input','stroke-color-input','fabric-input','fabric-toggle',
  'text-align-input'
].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', function() { drawProductCard(); updateThumbnails(); saveState(); });
  if (el && el.type === "checkbox") el.addEventListener('change', function() { drawProductCard(); updateThumbnails(); saveState(); });
});



function getMaxFontSize(ctx, text, maxWidth, fontFamily, fontWeight, userFontSize) {
  let size = userFontSize;
  ctx.font = `${fontWeight} ${size}px '${fontFamily}', sans-serif`;
  if (ctx.measureText(text).width <= maxWidth) return size;
  // Если не помещается — уменьшаем до тех пор, пока не влезет
  while (size > 10) {
    size--;
    ctx.font = `${fontWeight} ${size}px '${fontFamily}', sans-serif`;
    if (ctx.measureText(text).width <= maxWidth) return size;
  }
  return 10;
}
/* --- Рендер карточки --- */
function drawProductCard() {
  fixCanvasResolution(canvas);
  const ctx = canvas.getContext('2d');
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  // Фон
  if (bgImage) {
    ctx.save();
    ctx.globalAlpha = 1;
    ctx.drawImage(bgImage, 0, 0, w, h);
    ctx.restore();
  }

  // Затемнение фона (0-100%)
  let darken = parseInt(document.getElementById('bg-darken-input').value) || 0;
  if (darken > 0) {
    ctx.fillStyle = `rgba(34,34,34,${darken/100})`;
    ctx.fillRect(0, 0, w, h);
  }

  // Левая часть: фото товара
  const productAreaW = Math.floor(w * 0.55);
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,0.08)";
  ctx.fillRect(0, 0, productAreaW, h);
  ctx.restore();

  let img = productPhotoImages[currentPhotoIdx];
  if (img) {
    let scale = Math.min(productAreaW / img.width, h / img.height) * (sharedScale / 100);
    let imgW = img.width * scale;
    let imgH = img.height * scale;
    let imgX = (productAreaW - imgW) / 2 + sharedPosition.x;
    let imgY = (h - imgH) / 2 + sharedPosition.y;
    ctx.save();
    ctx.shadowColor = "#000";
    ctx.shadowBlur = 16;
    ctx.drawImage(img, imgX, imgY, imgW, imgH);
    ctx.restore();
  }

  // Правая часть: описание
  const brand = document.getElementById('brand-input').value;
  const category = document.getElementById('category-input').value;
  const sizeType = document.getElementById('size-type-input').value;
  const sku = document.getElementById('sku-input').value;
  const color = productPhotoImages.length ? batchColors[currentPhotoIdx] : document.getElementById('color-input').value;
  const fontSize = parseInt(document.getElementById('font-size-input').value);
  const fontFamily = document.getElementById('font-family-input').value;
  const textColor = document.getElementById('color-text-input').value;
  const strokeWidth = parseInt(document.getElementById('stroke-width-input').value);
  const strokeColor = document.getElementById('stroke-color-input').value;
  const textAlign = document.getElementById('text-align-input').value;
  const lineHeight = parseInt(document.getElementById('line-height-input').value);
  const circlePx = parseInt(document.getElementById('circle-size-input').value);
  const circleOffsetPercent = parseInt(document.getElementById('color-circle-offset-input').value);
  const circleXOffsetPx = parseInt(document.getElementById('color-circle-xoffset-input').value);

  ctx.save();
  ctx.font = `bold ${fontSize}px '${fontFamily}', sans-serif`;
  ctx.fillStyle = textColor;
  ctx.textBaseline = "top";
  let textX = productAreaW + 24;
  let textY = 40;
  let maxTextWidth = w - productAreaW - 40;

  drawLabelValue(ctx, "Тип модели:", templates[category] && templates[category][sizeType] ? templates[category][sizeType] : category, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
  textY += fontSize + lineHeight;
  drawLabelValue(ctx, "Бренд:", brand, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
  textY += fontSize + lineHeight;
  drawLabelValue(ctx, "Артикул:", sku, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
  textY += fontSize + lineHeight;
  drawLabelValue(ctx, "Розмір:", sizeMap[sizeType], textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
  textY += fontSize + lineHeight;

  if (document.getElementById('fabric-toggle').checked) {
    const fabric = document.getElementById('fabric-input').value;
    drawLabelValue(ctx, "Тканина:", fabric, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
    textY += fontSize + lineHeight;
  }

  drawColorLine(ctx, "Колір:", color, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, circlePx, circleOffsetPercent, circleXOffsetPx, strokeWidth, strokeColor);
  ctx.restore();
}

function drawLabelValue(ctx, label, value, x, y, fontSize, valueAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor) {
  ctx.save();
  ctx.font = `bold ${fontSize}px '${fontFamily}', sans-serif`;
  ctx.fillStyle = textColor;
  ctx.lineWidth = strokeWidth;
  ctx.strokeStyle = strokeColor;
  ctx.textAlign = valueAlign;
  let labelX = x;
  if (valueAlign === "center") labelX = x + maxTextWidth/2;
  if (valueAlign === "right") labelX = x + maxTextWidth;
  if (strokeWidth > 0) ctx.strokeText(label, labelX, y);
  ctx.fillText(label, labelX, y);
  let valueX = labelX + ctx.measureText(label).width + 10;
  ctx.textAlign = "left";
  if (strokeWidth > 0) ctx.strokeText(value, valueX, y);
  ctx.fillText(value, valueX, y);
  ctx.restore();
}
function drawColorLine(ctx, label, colorName, x, y, fontSize, align, maxTextWidth, textColor, fontFamily, circlePx, circleOffsetPercent, circleXOffsetPx, strokeWidth, strokeColor) {
  const colorHex = getColorHex(colorName);
  ctx.save();
  ctx.font = `bold ${fontSize}px '${fontFamily}', sans-serif`;
  ctx.fillStyle = textColor;
  ctx.lineWidth = strokeWidth;
  ctx.strokeStyle = strokeColor;
  ctx.textAlign = align;
  let labelX = x;
  if (align === "center") labelX = x + maxTextWidth/2;
  if (align === "right") labelX = x + maxTextWidth;
  if (strokeWidth > 0) ctx.strokeText(label, labelX, y);
  ctx.fillText(label, labelX, y);
  let valueX = labelX + ctx.measureText(label).width + 10;
  ctx.textAlign = "left";
  if (strokeWidth > 0) ctx.strokeText(colorName, valueX, y);
  ctx.fillText(colorName, valueX, y);
  let colorNameWidth = ctx.measureText(colorName).width;
  let circleR = circlePx / 2;
  let circleYOffset = fontSize * (circleOffsetPercent / 100);
  let circleXOffset = circleXOffsetPx;
  let circleCenterX = valueX + colorNameWidth + circleXOffset + circleR;
  ctx.beginPath();
  ctx.arc(circleCenterX, y + circleYOffset + fontSize/2, circleR, 0, 2 * Math.PI);
  ctx.fillStyle = colorHex;
  ctx.strokeStyle = "#222";
  ctx.lineWidth = 2;
  ctx.fill();
  ctx.stroke();
  ctx.restore();
}

/* --- СОХРАНЕНИЕ ВСЕХ КАРТОЧЕК В ZIP --- */
document.getElementById('save-btn').addEventListener('click', async function() {
  if (!productPhotoImages.length) return alert('Нет фото для сохранения!');
  const zip = new JSZip();
  const w = canvas.width, h = canvas.height;

  for (let idx = 0; idx < productPhotoImages.length; idx++) {
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = w;
    tempCanvas.height = h;
    const tempCtx = tempCanvas.getContext('2d');
    // Retina/HiDPI для временного канваса
    const dpr = window.devicePixelRatio || 1;
    tempCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
    tempCtx.imageSmoothingEnabled = true;

    // Фон
    if (bgImage) {
      tempCtx.save();
      tempCtx.globalAlpha = 1;
      tempCtx.drawImage(bgImage, 0, 0, w, h);
      tempCtx.restore();
    }

    // Затемнение
    let darken = parseInt(document.getElementById('bg-darken-input').value) || 0;
    if (darken > 0) {
      tempCtx.fillStyle = `rgba(34,34,34,${darken/100})`;
      tempCtx.fillRect(0, 0, w, h);
    }

    // Левая часть: фото товара
    const productAreaW = Math.floor(w * 0.55);
    tempCtx.save();
    tempCtx.fillStyle = "rgba(0,0,0,0.08)";
    tempCtx.fillRect(0, 0, productAreaW, h);
    tempCtx.restore();

    let img = productPhotoImages[idx];
    if (img) {
      let scale = Math.min(productAreaW / img.width, h / img.height) * (sharedScale / 100);
      let imgW = img.width * scale;
      let imgH = img.height * scale;
      let imgX = (productAreaW - imgW) / 2 + sharedPosition.x;
      let imgY = (h - imgH) / 2 + sharedPosition.y;
      tempCtx.save();
      tempCtx.shadowColor = "#000";
      tempCtx.shadowBlur = 16;
      tempCtx.drawImage(img, imgX, imgY, imgW, imgH);
      tempCtx.restore();
    }

    // Правая часть: описание (цвет индивидуальный!)
    const brand = document.getElementById('brand-input').value;
    const category = document.getElementById('category-input').value;
    const sizeType = document.getElementById('size-type-input').value;
    const sku = document.getElementById('sku-input').value;
    const color = batchColors[idx];
    const fontSize = parseInt(document.getElementById('font-size-input').value);
    const fontFamily = document.getElementById('font-family-input').value;
    const textColor = document.getElementById('color-text-input').value;
    const strokeWidth = parseInt(document.getElementById('stroke-width-input').value);
    const strokeColor = document.getElementById('stroke-color-input').value;
    const textAlign = document.getElementById('text-align-input').value;
    const lineHeight = parseInt(document.getElementById('line-height-input').value);
    const circlePx = parseInt(document.getElementById('circle-size-input').value);
    const circleOffsetPercent = parseInt(document.getElementById('color-circle-offset-input').value);
    const circleXOffsetPx = parseInt(document.getElementById('color-circle-xoffset-input').value);

    tempCtx.save();
    tempCtx.font = `bold ${fontSize}px '${fontFamily}', sans-serif`;
    tempCtx.fillStyle = textColor;
    tempCtx.textBaseline = "top";
    let textX = productAreaW + 24;
    let textY = 40;
    let maxTextWidth = w - productAreaW - 40;

    drawLabelValue(tempCtx, "Тип модели:", templates[category] && templates[category][sizeType] ? templates[category][sizeType] : category, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
    textY += fontSize + lineHeight;
    drawLabelValue(tempCtx, "Бренд:", brand, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
    textY += fontSize + lineHeight;
    drawLabelValue(tempCtx, "Артикул:", sku, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
    textY += fontSize + lineHeight;
    drawLabelValue(tempCtx, "Розмір:", sizeMap[sizeType], textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
    textY += fontSize + lineHeight;

    if (document.getElementById('fabric-toggle').checked) {
      const fabric = document.getElementById('fabric-input').value;
      drawLabelValue(tempCtx, "Тканина:", fabric, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, strokeWidth, strokeColor);
      textY += fontSize + lineHeight;
    }

    drawColorLine(tempCtx, "Колір:", color, textX, textY, fontSize, textAlign, maxTextWidth, textColor, fontFamily, circlePx, circleOffsetPercent, circleXOffsetPx, strokeWidth, strokeColor);
    tempCtx.restore();

    // --- Сохраняем PNG в архив ---
    const dataUrl = tempCanvas.toDataURL('image/png');
    zip.file(`product_${idx+1}.png`, dataUrl.split(',')[1], {base64: true});
  }

  // Скачиваем архив
  const content = await zip.generateAsync({type:"blob"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(content);
  a.download = 'products.zip';
  a.click();
});
// Закрытие модалок по клику вне окна и по Esc
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('mousedown', function(e) {
    if (e.target === modal) modal.style.display = 'none';
  });
});
window.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
  }
});

// Экспорт данных
document.getElementById('export-btn').onclick = function() {
  const data = {
    customColors: localStorage.getItem('customColors'),
    customBrands: localStorage.getItem('customBrands'),
    customCategories: localStorage.getItem('customCategories'),
    customFabrics: localStorage.getItem('customFabrics')
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mydata.json';
  a.click();
};

// Импорт данных
document.getElementById('import-btn').onclick = function() {
  document.getElementById('import-file').click();
};
document.getElementById('import-file').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.customColors) localStorage.setItem('customColors', data.customColors);
      if (data.customBrands) localStorage.setItem('customBrands', data.customBrands);
      if (data.customCategories) localStorage.setItem('customCategories', data.customCategories);
      if (data.customFabrics) localStorage.setItem('customFabrics', data.customFabrics);
      alert('Данные успешно импортированы! Перезагрузите страницу.');
    } catch (err) {
      alert('Ошибка при импорте файла!');
    }
  };
  reader.readAsText(file);
};



</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
      // ServiceWorker зарегистрирован
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}

window.addEventListener('resize', function() {
  fixCanvasResolution(canvas);
  drawProductCard();
});
</script>

</body>
</html>